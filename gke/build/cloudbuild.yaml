steps:
- id: 'decrypt SA credentials'
  name: gcr.io/cloud-builders/gcloud
  args:
  - kms
  - decrypt
  - --ciphertext-file=secrets/terraform-credentials.json.enc
  - --plaintext-file=secrets/credentials.json
  - --location=global
  - --keyring=terraform-keys
  - --key=cloudbuild-terraform

- id: 'tf init'
  name: 'hashicorp/terraform:0.12.17'
  entrypoint: 'sh'
  args:
  - '-c'
  - |
      cd gke
      terraform init -backend-config=./environments/$$ENV/backend.$$ENV.tf

- id: 'tf plan'
  name: 'hashicorp/terraform:0.12.17'
  entrypoint: 'sh'
  args:
  - '-c'
  - |
      cd gke
      terraform plan -var-file=./environments/$$ENV/terraform.$$ENV.tfvars

- id: 'tf apply'
  name: 'hashicorp/terraform:0.12.17'
  entrypoint: 'sh'
  args:
  - '-c'
  - |
      apk add --update jq bash curl
      cd gke
      terraform apply -auto-approve -var-file=./environments/$$ENV/terraform.$$ENV.tfvars
options:
  env:
  - 'ENV=demo'
  - 'GOOGLE_CLOUD_KEYFILE_JSON=/workspace/secrets/credentials.json'
  - 'GOOGLE_APPLICATION_CREDENTIALS=/workspace/secrets/credentials.json'
